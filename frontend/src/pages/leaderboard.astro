---
import { isError, leaderboard, getEvent } from "../api";
import Layout from "../layouts/Layout.astro";
import Countdown from "../components/Countdown.svelte";
import LeaderboardDisplay from "../components/Leaderboard.svelte";
import LeaderboardChart from "../components/LeaderboardChart.svelte";
import { jwtDecode } from "jwt-decode";

let teams;
const event = await getEvent();
const token = Astro.cookies.get("token")?.value;
if (new Date().getTime() >= event.start_time.getTime()) {
  teams = await leaderboard();
  if (isError(teams)) {
    if (teams.error === "invalid_token") return Astro.redirect("/login", 307);
    else return new Response("something went wrong");
  }
}
---

<Layout>
  {
    teams ? (
      <>
        <LeaderboardChart
          teams={teams.slice(0, 10).filter((team) => team.scoreHistory)}
          client:load
        />
        <LeaderboardDisplay
          teams={teams.filter((team) => team.score > 0)}
          yourTeam={token ? jwtDecode<{ team_id: string }>(token).team_id : null}
          client:load
        />
      </>
    ) : (
      <Countdown {event} client:load />
    )
  }
</Layout>
